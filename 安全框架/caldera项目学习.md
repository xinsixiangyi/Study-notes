## caldera

### 基本介绍

​	CALDERA ™是一个网络安全框架，旨在轻松运行自主的违规和模拟练习。它还可用于运行手动红团队参与或自动事件响应。卡尔德拉建在MITRE ATT&CK™框架之上，是MITRE的一个积极研究项目。

​	**CALDERA**中文名被译为火山口，是一个由python语言编写的红蓝对抗工具（攻击模拟工具）。是MITRE公司的一个研究项目，该工具的攻击流程是建立在ATT&CK攻击行为模型和知识库之上的，接近于APT攻击行为模式。（根据v4.2版本的ATT&CK攻击行为模型，一共分为14个主要攻击流程。）

![img](https://pics1.baidu.com/feed/c2cec3fdfc0392454ad5b15626318fca7c1e25b0.jpeg?token=b7f25d572ad764ac04d416e6ea00dbc7)

框架由两个部分组成： 

​	核心系统：带有 REST API 和 Web 界面的异步命令和控制（C2）服务器的框架代码。

​	插件：悬挂在核心框架上的单独存储库，提供其他功能，例如代理、GUI 接口、TTP 集合等。

CALDERA可以手动**模拟红队**事先设定好攻击流程，进行自动化攻击和事件响应，同时也可以扮演蓝队根据相应的威胁做出应对手段。



#####  **红队（Red Team）是什么？**

红队的说法起源于军事中，在战争中人们意识到，为了更好地防御，需要攻击自己的防御系统以发现薄弱点，然后可以更好地防御。从而逐渐地演变成“战争游戏”，也就是“红蓝对抗”。

红队的职责要尽可能模拟真实世界中收集政治、经济和科技情报的境外国家资助的黑客团伙等，红队测试某种程度上可以说是**合法的高级持续性威胁**(APT)。在这种完全贴近真实攻击的测试活动中，能够测试企业安全防护体系的阻断（prevention）、检测（detection）和响应（response）能力。

##### **渗透测试和红队的区别**

渗透测试中只关注给定目标系统的漏洞，红队测试则完全不一样。

红队在测试过程中关注的是如何规划一条攻击路径来达到目的。在整个红队测试过程中不一定要也不一定会发现目标组织的漏洞，只要能达到目的，任何形式的攻击手段都可以使用，包括但不限于web或者操作系统漏洞、社会工程学、物理渗透、攻击上下游合作供应商等。

如果说渗透测试是点到为止的话，那么红队测试就是不讲武德。

##### **Campaigns/Agents模块**

靶机：Centos7 64（IP：192.168.178.154）

###### **1. 登录**

有三个默认账户：

![img](https://pics0.baidu.com/feed/f7246b600c3387441e869b03f8aaf2f1d62aa0b8.jpeg?token=282ec0c86e3c110f61ba44e869b4bc80)

我们先以red用户作为演示。

###### **2. agents**

用户登录后点击左上角的**Navigate(导航栏)**，我们可以看到CALDERA的所有功能和模块。我们先来演示一下**agents模块**的用法。

![image-20210812131923767](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812131923767.png)

打开模块后，先点击”**Clieck here to deploy an agent**”(点击发送一个代理)，然后根据我们的需求选择payload类型和靶机的操作系统

如图，我选择的是**Ragdoll: A Python agent which communicates via the HTML contact以及LINUX系统**

![image-20210812132021482](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812132021482.png)

在靶机上执行生成的powershell命令，建立代理链接

回到CALDERA的agents页面,可以看到一条新的链接建立（如果没有请刷新页面），成功的话会显示在界面。

![image-20210812132035387](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812132035387.png)



点击PID号可以查看该链接的详细信息。

![image-20210812132051424](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812132051424.png)

这些信息中包括了连接方式、主机名、用户名、用户权限、连接时间、处理器、操作系统、代理的运行程序等等。

###### **3.Adversaries（敌手）**

**Adversaries**翻译中文为“敌手”，这一项的功能的配置文件包含了基于ATT&CK的大部分战术集合（大部分攻击配置还未完善），可以在红队端进行特定的攻击战术配置，还允许上传自定义payload来作为战术的一部分进行使用。

我们可以点击“VIEW”来自由搭配我们的战术集合，也可以点击下拉菜单“Select an existing profile”来选择工具已经提供的一些战术，在原有的战术中进行添加或者调整。

###### **4.Operations(行动)**

顾名思义，这一项功能就是对设定好的攻击行为做出行动。

点击“operations”，再在弹出的功能框中点击“VIEW”添加行动。

运行结果中可以看到，并不是所有的行动都能成功执行，这取决于系统的版本，payload的有效性和网络状态等多方面因素。执行成功的状态颜色为绿色(失败为红色、超时为蓝色)，可以通过点击每个行动后方的星星来查看反馈。

###### **5.其他相关插件**

**【Plugins->Debrief】**

该功能能够将已执行过的行动生成攻击流程图和行动关联图，便于攻击后的复盘分析。

![image-20210812142825148](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812142825148.png)

**【Plugins->GameBoard】**

作为在演习中监视红队和蓝队的行动，看蓝队能否够检测到红队的行为，做出响应，中断攻击行为。以竞技的界面进行展示，任意一方只要做出有效的响应就能获得分数。

面板中显示选择的红队在这次实验中已经获得了5分。

![image-20210812142921960](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812142921960.png)

**【Advanced->Configuration】**

可以对通讯连接的地址及插件进行配置，我们可以将各个服务的IP地址改为CALDERA主机的IP地址，方便以后的使用。

![image-20210812142947714](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812142947714.png)

**【Advanced->Obfuscators】**

介绍红队行动前混淆模式的介绍，方便红队使用该功能，用于逃避检测。

![image-20210812143016611](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812143016611.png)

目前提供的混淆模式：

plain-text：明文base64：base64编码混淆base64jumble：混淆base64中的命令，然后添加字符以逃避base64检测。这可能会导致重复连接运行。caesar cipher：凯撒加密混淆base64noPadding：base64编码混淆，然后删除填充Steganography：图像隐写

**【Advanced->Planners】**

这是一个策略器，用于一个正在运行的操作应该如何决定使用哪些功能以及何种顺序。具体地说，策略器的逻辑包含执行操作的单个阶段的决策。

![image-20210812143745170](caldera%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.assets/image-20210812143745170.png)

### CALDERA分步指南

#### 1、红队自主参与

(Autonomous red-team engagements)

包括登录、部署代理、选择对手和运行操作

#### 2、自主事件响应

(Autonomous red-team engagements)

包括登录、部署代理、选择防御者和运行操作

。